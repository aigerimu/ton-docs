
# RUNVM Specification

Currently, TVM does not provide a mechanism for executing external untrusted code within a secure sandbox environment. In other words, any external code invoked has unrestricted access and can permanently modify the contract's code and data or trigger actions such as transferring all funds.

The `RUNVM` instruction creates an isolated VM instance, allowing code execution while safely retrieving data such as stack state, registers, and gas consumption. This ensures the caller's state remains unaffected. This allows arbitrary code to run safely, which is helpful for [v4-style plugins](/v3/documentation/smart-contracts/contracts-specs/wallet-contracts#wallet-v4), Tact's `init`-style subcontract calculations, and similar use cases.

| Fift syntax | Stack | Description                                                                                                                                                                                                                                                                                                                                                                                                          |
|:-|:-|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `flags RUNVM` | _`x_1 ... x_n n code [r] [c4] [c7] [g_l] [g_m] - x'_1 ... x'_m exitcode [data'] [c4'] [c5] [g_c]`_ | Executes a child VM with the given `code` and stack values `x_1 ... x_n`. Returns the modified stack `x'_1 ... x'_m` along with an exit code. <br/> Flags determine other arguments and return values. See details below.|
| `RUNVMX` | _`x_1 ... x_n n code [r] [c4] [c7] [g_l] [g_m] flags - x'_1 ... x'_m exitcode [data'] [c4'] [c5] [g_c]`_ | It is the same as `RUNVM` but retrieves flags from the stack.                                                                                                                                                                                                                                                                                                                                                        |


Flags operate similarly to `RUNVMX` in Fift:

- `+1`: Sets `c3` to code.
- `+2`: push an implicit 0 before running the code
- `+4`: take `c4` from stack (persistent data), return its final value
- `+8`: take gas limit `g_l` from stack, return consumed gas `g_c`
- `+16`: take `c7` from stack (smart-contract context)
- `+32`: return final value of `c5` (actions)
- `+64`: pop hard gas limit (enabled by ACCEPT) `g_m` from stack
- `+128`: "isolated gas consumption". Child VM will have a separate set of visited cells and a separate chksgn counter.
- `+256`: pop integer `r`, return exactly `r` values from the top:
- If RUNVM call successful and r is set, it returns r elements. If r not set - returns all;
- if RUNVM successful but there is not enough elements on stack (stack depth less than r) it is considered as exception in child VM, with exit_code=-3 and exit_arg=0 (so 0 is returned as only stack element);
- if RUNVM fails with exception - only one element is returned - exit arg (not to be mistaken with exit_code);
- in case of OOG, exit_code = -14 and exit_arg is amount of gas.

Gas cost:
- 66 gas
- 1 gas for every    stack element given to the child VM (first 32 are free)
- 1 gas for every stack element returned from the child VM (first 32 are free)

## See Also

- [TVM Instructions](/v3/documentation/tvm/instructions)
