# Сообщения

Все взаимодействия cо смарт контрактами в тоне построено на сообщениях. Сообщения чем-то похожи на запросы к серверу. Каждый смарт контракт имеет обработчик сообщений и выполняет определенную логику, по приходу сообщения.

## Типы сообщений
Всего есть три типа сообщений:
* internal 
* external 
* external-out

### External
Начнём с external сообщений. External сообщение это просто сообщение с данными к конкретному смарт контракту. То есть любой человек может отправить произвольные данные на любой смарт контракт, а смарт контракт решит, что с этим сообщением делать. Это относительно редко используемая логика, но у неё есть одно самое важное применение – контракты кошельков.

Почти любое действие в блокчейне начинается с external сообщение к кошельку. То есть, когда пользователь хочет кому-то перевести тоны или например совершить обмен на дексе, он посылает external сообщение на свой кошелёк с подписанными данными.

### Internal
Теперь об internal сообщениях. Когда кошелек получает external сообщение он проверяет подпись, и если всё корректно кошелек посылает уже internal сообщение на другой смарт контракт. У internal сообщения есть несколько важных отличий – помимо данных, к сообщению может быть прикреплено некоторое количество тонов, а ещё у internal сообщения есть отправитель, то есть в нашем примере отправитель это наш кошелек.

Говоря немного иначе internal сообщение – это сообщение от одного смарт контракта к другому. При получении internal сообщения смарт контракт знает сколько к этому сообщению было прикреплено тонов и кто отправитель этого сообщения. Корректность этих данных гарантируется блокчейном, соответственно смарт контракт может им доверять.

### External-out
External-out (их ещё иногда называют Events) – это просто данные которые генерирует смарт контракт и никуда не отправляет. Редкий тип сообщения, по своей сути очень похож на логи. По большей части нужен просто для облегчения индексации блокчейна. Например дедаст генерирует external out сообщение при успешном свапе, чтобы другим сервисам был.

## Данные в сообщении
Теперь о данных в сообщении. Мы уже говорили что и в external, и internal сообщениях могут содержаться какие-то данные. Но как именно эти данные передавать? В тоне все данные представлены в виде ячеек. Для того чтобы закодировать данные в ячейку, существует общепринятый стандарт для описания сериализации этих данных – TL-B.

Простейший практический контракт в тоне – это счетчик. Рассмотрим такой гипотетический пример и примеры возможных сообщений к нему. Пусть смарт контракт может совершать два действия, увеличить или уменьшить внутреннюю переменную в нём. Тогда возможные сообщения описанные на языке TL-B будут выглядеть примерно так:

#### General form

```
increase#34a3ff12 query_id:uint64 amount:uint32 = InternalMsgBody;
decrease#e4d5986b query_id:uint64 amount:uint32 = InternalMsgBody;
```

Это схема описывает тело сообщения (сами данные). Когда мы работаем с сообщением, то тело сообщения и количество прикрепленных к нему тон – это два самых важных параметра.

В теле сообщения есть два конвенциональных поля – opcode и query_id. opcode – это 32-битное число означающее тип операции, а query_id – 64-битное число, которое смарт контракт никак не должен использовать, и нужное лишь для удобства внешним сервисам.

Так в коде чтобы собрать тело сообщения

```
function generateMessageBody(amount: bigint): Cell {
const op = 0x34a3ff12;
const queryId = randomUint64();
const body = beginCell()
.storeUint(op, 32)
.storeUint(queryId, 64)
.storeUint(amount, 32)
.endCell();

    return body;
}
```

## Отправка сообщения

Есть два практических и важных для отличия случая, как можно отправить сообщение в блокчейн. Либо мы отсылаем сообщение с бэкенда являемся владельцем кошелька и можем сразу подписать и отправить сообщение в блокчейн, либо используя TON Connect на фронтенде мы можем собрать сообщение и предложить пользователю подписать и отправить его самому.
### Отправка с бэкенда 

Когда у нас есть кошелек с сид фразой отправление сообщения происходит так
Код [отсюда](https://docs.ton.org/v3/guidelines/dapps/cookbook#how-to-transfer-ton-and-send-a-text-message-to-another-wallet)

### Отправка с фронтенда (TON Connect)
Тут мы просто предлагаем пользователю подписать сообщение

```
const myTransaction = {
validUntil: Math.floor(Date.now() / 1000) + 60, // 60 sec
messages: [
{
address: destination, // Address of smart contract to send internal message to
amount: amount, // Amount in nanotons to attach to the message
payload: Base64.encode(messageBody.toBoc())
}
]
}

tonConnectUI.sendTransaction(myTransaction)

```